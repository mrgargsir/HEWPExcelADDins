name: Build & Release HEWP Tools

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout your repo
      - uses: actions/checkout@v4

      # 2. Determine Version (smart bump logic)
      - name: Determine Version
        id: get_version
        run: |
          FILE=$(find . -type f -name 'MRGARGSIR-Tools-v*.xlsm' | head -n 1)
          if [ -z "$FILE" ]; then
            echo "❌ No version file found. Make sure a file named like MRGARGSIR-Tools-v*.xlsm exists."
            exit 1
          fi
          echo "Found version file: $FILE"

          BASE_VERSION=$(echo "$FILE" | grep -oP 'v\K\d+(\.\d+)?(\.\d+)?')
          echo "Base version: $BASE_VERSION"

          FINAL_VERSION="$BASE_VERSION"

          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            FINAL_VERSION=$(printf "%.4f" "$(echo "$BASE_VERSION + 0.0001" | bc)")
            echo "⚙️ Manually triggered. Bumped version to: $FINAL_VERSION"
          else
            CHANGED=$(git diff --name-only HEAD~1 HEAD || true)
            echo "Changed files:"
            echo "$CHANGED"

            if echo "$CHANGED" | grep -qF "$FILE"; then
              echo "✅ .xlsm file was modified. Using base version: $FINAL_VERSION"
            elif echo "$CHANGED" | grep -qE '^OtherFiles/|^.*'; then
              FINAL_VERSION=$(printf "%.2f" "$(echo "$BASE_VERSION + 0.01" | bc)")
              echo "🆕 Files in OtherFiles or main branch changed. Bumped version to: $FINAL_VERSION"
            else
              echo "📦 No relevant changes. Keeping base version: $FINAL_VERSION"
            fi
          fi

          echo "VERSION=v$FINAL_VERSION" >> $GITHUB_ENV
          echo "VERSION_SHORT=$FINAL_VERSION" >> $GITHUB_ENV

      # 3. Download latest release ZIP from external repo (no extract)
      - name: Download .zip from mrgargsir/HEWPContractorextension (No extract)
        id: download_external_zip
        uses: robinraju/release-downloader@v1.10
        with:
          repository: mrgargsir/HEWPContractorextension
          latest: true
          fileName: "*.zip"
          extract: false
          out-file-path: ./

      # 4. Place external ZIP into OtherFiles/ keeping original name
      - name: Place external ZIP into OtherFiles/
        run: |
          mkdir -p OtherFiles
          cp "${{ steps.download_external_zip.outputs.downloadedFileName }}" OtherFiles/

      # 5. Create combined ZIP file with versioned name
      - name: Create Combined ZIP
        run: |
          ZIP_NAME="HEWPTools&UtilityByMRGARGSIR_${VERSION_SHORT}.zip"
          zip -r "$ZIP_NAME" OtherFiles $(find . -type f -name 'MRGARGSIR-Tools-v*.xlsm')
          echo "ZIP_NAME=$ZIP_NAME" >> $GITHUB_ENV

      # 6. Get latest commit message for release notes
      - name: Get Commit Message for Release Notes
        id: changelog
        run: |
          DESC=$(git log -1 --pretty=%B)
          echo "RELEASE_BODY<<EOF" >> $GITHUB_ENV
          echo "$DESC" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      # 7. Create GitHub Release
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.VERSION }}
          name: "HEWP Tools ${{ env.VERSION }}"
          body: ${{ env.RELEASE_BODY }}
          files: ${{ env.ZIP_NAME }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 8. Upload ZIP artifact (optional)
      - name: Upload ZIP Artifact
        uses: actions/upload-artifact@v4
        with:
          name: hewp-tools-${{ env.VERSION_SHORT }}
          path: ${{ env.ZIP_NAME }}
